# Задача: Исправление таймаутов Nginx для синхронизации Яндекс.Бизнес

**Дата:** 2025-01-03  
**Приоритет:** Высокий  
**Исполнитель:** Кодер

---

## Проблема

Синхронизация Яндекс.Бизнес обрывается по таймауту Nginx. Текущие таймауты (300 секунд) недостаточны для бизнесов с большим объемом данных.

---

## Анализ проблемы

### Как работает синхронизация

**Синхронизация Яндекс.Бизнес - СИНХРОННАЯ** (не через очередь):
- Эндпоинт `/api/admin/yandex/sync/business/<business_id>` вызывает парсер напрямую
- Парсер выполняет несколько запросов последовательно:
  1. `parser.fetch_reviews()` - может быть много страниц (каждая страница = 30 сек таймаут)
  2. `parser.fetch_stats()` - несколько запросов
  3. `parser.fetch_posts()` - может быть много страниц
  4. `parser.fetch_photos()` - может быть много страниц

### Время выполнения

- **Каждый HTTP запрос:** таймаут 30 секунд (из `yandex_business_parser.py`)
- **Отзывы:** если 10 страниц = до 300 секунд (5 минут)
- **Посты:** если 5 страниц = до 150 секунд
- **Фото:** если 5 страниц = до 150 секунд
- **Итого:** для бизнеса с большим объемом данных может быть **5-10 минут**

### Текущие таймауты Nginx

```nginx
proxy_read_timeout 300s;
proxy_connect_timeout 300s;
proxy_send_timeout 300s;
```

**Проблема:** 300 секунд (5 минут) может быть недостаточно для бизнесов с большим количеством отзывов/постов/фото.

---

## Решение

### Вариант 1: Увеличить таймауты Nginx (быстрое решение)

**Файл:** Конфигурация Nginx (обычно `/etc/nginx/sites-available/default` или `/etc/nginx/nginx.conf`)

**Изменения:**
```nginx
# Увеличить таймауты до 600 секунд (10 минут)
proxy_read_timeout 600s;
proxy_connect_timeout 600s;
proxy_send_timeout 600s;

# Отключить буферизацию для больших ответов (уже сделано)
proxy_buffering off;

# Использовать 127.0.0.1 вместо localhost (уже сделано)
proxy_pass http://127.0.0.1:8000;
```

**Шаги:**
1. Найти конфигурацию Nginx на сервере
2. Увеличить таймауты до 600 секунд
3. Перезагрузить Nginx: `systemctl reload nginx`
4. Проверить логи после следующей синхронизации

---

### Вариант 2: Сделать синхронизацию асинхронной (правильное решение)

**Преимущества:**
- Не зависит от таймаутов Nginx
- Пользователь сразу получает ответ "синхронизация запущена"
- Обработка идет в фоне через worker
- Можно обрабатывать несколько бизнесов параллельно

**Файлы для изменения:**
- `src/main.py` - эндпоинт `/api/admin/yandex/sync/business/<business_id>`
- `src/worker.py` - добавить обработку задач синхронизации
- Создать таблицу `SyncQueue` или использовать существующую `ParseQueue`

**Шаги:**
1. Использовать `ParseQueue` с новым типом задачи `task_type = 'sync_yandex_business'`
2. Изменить эндпоинт: вместо прямого вызова парсера - добавить задачу в ParseQueue
3. Вернуть ответ: `{"success": true, "message": "Синхронизация запущена, обработка в фоне"}`
4. Добавить обработку задач синхронизации в `worker.py` (объединить с обработкой ParseQueue)
5. Обрабатывать задачи синхронизации в фоне через единую очередь

**Примечание:** См. также `TASK_UNIFY_QUEUES.md` - объединение SyncQueue и ParseQueue в единую очередь

**Пример изменения эндпоинта:**
```python
# Было (синхронно):
parser = YandexBusinessParser(auth_data_dict)
reviews = parser.fetch_reviews(account_data)
# ... обработка ...

# Стало (асинхронно):
# Добавляем задачу в ParseQueue с типом sync_yandex_business
cursor.execute("""
    INSERT INTO ParseQueue (id, business_id, account_id, task_type, source, status, user_id, created_at, updated_at)
    VALUES (?, ?, ?, 'sync_yandex_business', 'yandex_business', 'pending', ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
""", (task_id, business_id, account_id, user_data["user_id"]))
db.conn.commit()

return jsonify({
    "success": True,
    "message": "Синхронизация запущена, обработка в фоне",
    "task_id": task_id
})
```

---

## Рекомендация

**Для быстрого решения:** Вариант 1 (увеличить таймауты до 600 секунд)

**Для правильного решения:** Вариант 2 (асинхронная обработка через очередь)

**Можно сделать оба варианта:**
1. Сначала увеличить таймауты (быстрое решение)
2. Потом сделать асинхронную обработку (правильное решение)

---

## Чеклист для кодера

### Вариант 1: Увеличить таймауты

- [ ] Найти конфигурацию Nginx на сервере
- [ ] Увеличить `proxy_read_timeout` до 600s
- [ ] Увеличить `proxy_connect_timeout` до 600s
- [ ] Увеличить `proxy_send_timeout` до 600s
- [ ] Проверить синтаксис: `nginx -t`
- [ ] Перезагрузить Nginx: `systemctl reload nginx`
- [ ] Проверить логи после синхронизации: `tail -f /var/log/nginx/error.log`

### Вариант 2: Асинхронная обработка (рекомендуется вместе с TASK_UNIFY_QUEUES.md)

- [ ] Использовать `ParseQueue` с `task_type = 'sync_yandex_business'` (см. TASK_UNIFY_QUEUES.md)
- [ ] Изменить эндпоинт `/api/admin/yandex/sync/business/<business_id>`:
  - Убрать прямой вызов парсера
  - Добавить задачу в очередь
  - Вернуть ответ "синхронизация запущена"
- [ ] Добавить обработку задач синхронизации в `worker.py`:
  - Проверять задачи со статусом `pending`
  - Вызывать парсер для каждой задачи
  - Обновлять статус на `completed` или `error`
- [ ] Добавить эндпоинт для проверки статуса синхронизации:
  - `GET /api/admin/yandex/sync/status/<sync_id>`
- [ ] Протестировать:
  - Запустить синхронизацию
  - Проверить, что задача добавлена в очередь
  - Проверить, что worker обрабатывает задачу
  - Проверить, что данные синхронизированы

---

## Проверка после исправления

### Проверить таймауты Nginx

```bash
# Найти конфигурацию
nginx -T | grep -A 5 "proxy_read_timeout"

# Проверить синтаксис
nginx -t

# Перезагрузить
systemctl reload nginx

# Проверить статус
systemctl status nginx
```

### Проверить логи после синхронизации

```bash
# Логи Nginx
tail -f /var/log/nginx/error.log

# Логи Flask
tail -f /tmp/seo_main.out

# Проверить, что синхронизация завершилась успешно
# (данные должны появиться в ExternalBusinessReviews, ExternalBusinessStats)
```

---

## Ожидаемый результат

**После исправления:**
- Синхронизация не должна обрываться по таймауту
- Для бизнесов с большим объемом данных синхронизация должна завершаться успешно
- Логи должны показывать полное время выполнения синхронизации

**Если проблема сохранится:**
- Проверить логи Flask - возможно, парсер зависает на конкретном запросе
- Проверить, не превышает ли время выполнения 600 секунд
- Рассмотреть вариант 2 (асинхронная обработка)

---

## Дополнительная информация

**Файлы для изучения:**
- `src/main.py` - эндпоинт `/api/admin/yandex/sync/business/<business_id>` (строки 5484-5595)
- `src/yandex_business_parser.py` - парсер с таймаутами 30 секунд
- `src/worker.py` - пример асинхронной обработки через очередь
- Конфигурация Nginx на сервере

**Связанные задачи:**
- Оптимизация парсера (уменьшение времени выполнения)
- Мониторинг времени синхронизации

