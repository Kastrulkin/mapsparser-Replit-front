# Phase 3.5 Step 1: –ó–∞–ø—É—Å–∫ USE_REVIEW_REPOSITORY

**–î–∞—Ç–∞:** 2026-02-01  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–í–´–ü–û–õ–ù–ï–ù–û** - Step 1 —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ production (read-only)

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# 1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å .env –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
./scripts/start_phase35_step1.sh

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å Flask
python3 src/main.py

# 3. –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ - –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
./scripts/test_phase35_step1.sh YOUR_BUSINESS_ID
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–π

```bash
# 1. –î–æ–±–∞–≤–∏—Ç—å –≤ .env
cat >> .env << EOF

# Phase 3.5 Repository Pattern - Step 1
USE_REVIEW_REPOSITORY=true
USE_SERVICE_REPOSITORY=false
USE_BUSINESS_REPOSITORY=false
EOF

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å Flask
python3 src/main.py

# 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å (–≤ –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:8000/api/business/YOUR_BUSINESS_ID/external/reviews
```

---

## üìã –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Step 1

**USE_REVIEW_REPOSITORY=true** –≤–∫–ª—é—á–∞–µ—Ç:
- ‚úÖ –ß—Ç–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤ —á–µ—Ä–µ–∑ `ReviewRepository` –≤–º–µ—Å—Ç–æ raw SQL
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ explicit column lists (–±–µ–∑ SELECT *)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ (debug level)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- ‚úÖ –¢–æ–ª—å–∫–æ SELECT –æ–ø–µ—Ä–∞—Ü–∏–∏ (—á—Ç–µ–Ω–∏–µ)
- ‚úÖ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ë–î
- ‚úÖ Rollback –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–æ–∫
- ‚úÖ Legacy –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ fallback

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Ñ–ª–∞–≥ –≤–∫–ª—é—á–µ–Ω

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å .env
grep USE_REVIEW_REPOSITORY .env
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: USE_REVIEW_REPOSITORY=true
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ Flask –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–ª–∞–≥

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ Flask –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ –ª–æ–≥–∏:
- –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ SQL –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (debug level) - —Ñ–ª–∞–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ï—Å–ª–∏ –Ω–µ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ - —Ñ–ª–∞–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 3. –¢–µ—Å—Ç endpoint

```bash
# –° —Ç–æ–∫–µ–Ω–æ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:8000/api/business/YOUR_BUSINESS_ID/external/reviews

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# {
#   "success": true,
#   "reviews": [...],
#   "total": N,
#   "with_response": M,
#   "without_response": K
# }
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫

**–ß—Ç–æ –∏—Å–∫–∞—Ç—å –≤ –ª–æ–≥–∞—Ö Flask (–ø–µ—Ä–≤—ã–µ 15-30 –º–∏–Ω—É—Ç):**
- ‚ùå `IntegrityError` - –Ω–∞—Ä—É—à–µ–Ω–∏–µ constraints
- ‚ùå `violat` - –Ω–∞—Ä—É—à–µ–Ω–∏–µ constraints
- ‚ùå `traceback` - –æ—à–∏–±–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- ‚ùå `rollback` - –æ—Ç–∫–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è SELECT)

**–ï—Å–ª–∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ç** - Step 1 —É—Å–ø–µ—à–µ–Ω! ‚úÖ

---

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –í–∞—Ä–∏–∞–Ω—Ç 1: –°–º–æ—Ç—Ä–µ—Ç—å –≤—ã–≤–æ–¥ Flask –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ

–ï—Å–ª–∏ Flask –∑–∞–ø—É—â–µ–Ω –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ - –ø—Ä–æ—Å—Ç–æ —Å–º–æ—Ç—Ä–∏—Ç–µ –≤—ã–≤–æ–¥.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –õ–æ–≥–∏ –≤ —Ñ–∞–π–ª

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å Flask —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
python3 src/main.py > /tmp/seo_main_phase35.log 2>&1 &

# –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
tail -f /tmp/seo_main_phase35.log | grep -i "integrity\|violat\|error\|rollback"
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ journalctl (–µ—Å–ª–∏ systemd –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

```bash
journalctl -u beautybot-backend -f | grep -i "integrity\|violat\|error"
```

---

## ‚ö†Ô∏è –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –û—à–∏–±–∫–∞: IntegrityError

**–ü—Ä–∏—á–∏–Ω–∞:** Constraints –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏–ª–∏ orphaned records

**–†–µ—à–µ–Ω–∏–µ:**
1. –í—ã–∫–ª—é—á–∏—Ç—å —Ñ–ª–∞–≥: `USE_REVIEW_REPOSITORY=false`
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Flask
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å constraints (—Å–º. —á–µ–∫–ª–∏—Å—Ç)
4. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É
5. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å Step 1

### –û—à–∏–±–∫–∞: ImportError / ModuleNotFoundError

**–ü—Ä–∏—á–∏–Ω–∞:** –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
ls -la src/repositories/

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Python path
python3 -c "from repositories.review_repository import ReviewRepository; print('OK')"
```

### –û—à–∏–±–∫–∞: Connection error

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–±–ª–µ–º—ã —Å –ë–î

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `get_db()` —Ä–∞–±–æ—Ç–∞–µ—Ç
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Flask

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ Step 1

- [x] Flask –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [x] Endpoint `/api/business/<id>/external/reviews` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö –∑–∞ 15-30 –º–∏–Ω—É—Ç (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)
- [x] Response —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ –∏ —Ä–∞–Ω—å—à–µ (legacy)

### ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (2026-02-01)

**–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ:**
- ‚úÖ HTTP Code: 200
- ‚úÖ Endpoint: `/api/business/6620421e-527a-45a1-8001-16822b87d01c/external/reviews`
- ‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã —á–µ—Ä–µ–∑ `ReviewRepository` (USE_REVIEW_REPOSITORY=true)
- ‚úÖ –í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤: 72 (32 —Å –æ—Ç–≤–µ—Ç–∞–º–∏, 40 –±–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤)
- ‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
- ‚úÖ –û—à–∏–±–æ–∫ –≤ –æ—Ç–≤–µ—Ç–µ –Ω–µ—Ç
- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ç–æ–∫–µ–Ω —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

**–°—Ç–∞—Ç—É—Å:** Step 1 —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ production-—Ä–µ–∂–∏–º–µ (read-only)

**–ï—Å–ª–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (15-30 –º–∏–Ω—É—Ç) –ø—Ä–æ–π–¥–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫ - –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ Step 2 —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞**

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ Step 1:

1. **–ß–µ—Ä–µ–∑ 24 —á–∞—Å–∞:** –í–∫–ª—é—á–∏—Ç—å Step 2 (`USE_SERVICE_REPOSITORY=true`)
2. **–ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é:** –í–∫–ª—é—á–∏—Ç—å Step 3 (`USE_BUSINESS_REPOSITORY=true`)

–°–º. `.cursor/docs/PHASE_3_5_PRODUCTION_CHECKLIST.md` –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.

---

## üîÑ –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

```bash
# 1. –í—ã–∫–ª—é—á–∏—Ç—å —Ñ–ª–∞–≥
sed -i.bak 's/^USE_REVIEW_REPOSITORY=.*/USE_REVIEW_REPOSITORY=false/' .env

# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Flask
# (Ctrl+C –µ—Å–ª–∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ, –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å systemd —Å–µ—Ä–≤–∏—Å)

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç legacy –∫–æ–¥
curl http://localhost:8000/api/business/YOUR_BUSINESS_ID/external/reviews
```

–°–∏—Å—Ç–µ–º–∞ –≤–µ—Ä–Ω–µ—Ç—Å—è –∫ legacy –∫–æ–¥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
