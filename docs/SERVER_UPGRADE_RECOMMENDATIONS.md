# Рекомендации по апгрейду сервера

## ✅ Текущие характеристики (HP C2-M4-D20) - ОБНОВЛЕНО
- **CPU**: 2 vCPU ✅
- **RAM**: 4 ГБ ✅
- **Диск**: 20 ГБ ✅

**Статус**: ✅ **Рекомендуемая конфигурация достигнута!** Сервер должен работать стабильно.

## Проблема (решена)

### Почему сервер вис (было)

**1. Недостаточно памяти (RAM)**
- Flask сервер: ~150-300 МБ
- Worker процесс (Playwright): ~200-400 МБ
- Nginx: ~20-50 МБ
- Система (OS): ~200-300 МБ
- **Итого минимум: ~600-1000 МБ**

При сборке фронтенда (`npm run build`):
- Node.js + Vite: ~500-800 МБ
- **Итого во время сборки: ~1100-1800 МБ** ❌

**2. Недостаточно CPU**
- 1 ядро не справляется с одновременной работой:
  - Flask сервер
  - Worker (парсинг с Playwright)
  - Сборка фронтенда
  - Обработка запросов

**3. Результат**
- Сервер уходит в swap (медленный диск вместо RAM)
- Процессы зависают
- SSH соединения обрываются
- 502 Bad Gateway ошибки

## Рекомендации по апгрейду

### Минимальная конфигурация (для стабильной работы)
- **CPU**: 2 vCPU
- **RAM**: 2-3 ГБ
- **Диск**: 20 ГБ (достаточно)

### Рекомендуемая конфигурация (для комфортной работы)
- **CPU**: 2-4 vCPU
- **RAM**: 4 ГБ
- **Диск**: 20-30 ГБ

### Оптимальная конфигурация (для роста)
- **CPU**: 4 vCPU
- **RAM**: 8 ГБ
- **Диск**: 30-50 ГБ

## Временные оптимизации (до апгрейда)

### 1. Остановить worker во время сборки
```bash
# Перед сборкой фронтенда
systemctl stop seo-worker

# После сборки
systemctl start seo-worker
```

### 2. Собирать фронтенд локально
Собирать фронтенд на локальной машине и загружать только `dist/` на сервер:
```bash
# Локально
cd frontend
npm run build
tar czf dist.tar.gz dist/

# На сервере (через веб-консоль)
cd /root/mapsparser-Replit-front
rm -rf frontend/dist
tar xzf dist.tar.gz -C frontend/
```

### 3. Ограничить использование памяти для процессов
Создать systemd unit с ограничениями:
```bash
# /etc/systemd/system/seo-main.service
[Service]
MemoryLimit=512M
CPUQuota=50%
```

### 4. Использовать swap файл (временное решение)
```bash
# Создать swap файл 2 ГБ
fallocate -l 2G /swapfile
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile

# Добавить в /etc/fstab для автозагрузки
echo '/swapfile none swap sw 0 0' >> /etc/fstab
```

⚠️ **Внимание**: Swap медленнее RAM, но поможет избежать зависаний.

### 5. Оптимизировать сборку фронтенда
```bash
# Использовать меньше памяти при сборке
cd frontend
NODE_OPTIONS="--max-old-space-size=512" npm run build
```

## Проверка текущей нагрузки

```bash
# Проверить использование памяти
free -h

# Проверить использование CPU
top -bn1 | head -5

# Проверить процессы
ps aux --sort=-%mem | head -10

# Проверить swap
swapon --show
```

## План действий

### ✅ Выполнено
1. ✅ Апгрейд до 2 vCPU + 4 ГБ RAM
2. ✅ Рекомендуемая конфигурация достигнута

### Немедленно (после апгрейда)
1. ✅ Перезапустить все процессы для использования новых ресурсов
2. ✅ Проверить, что сервер работает стабильно
3. ✅ Очистить ненужные файлы (см. `docs/CLEANUP_SERVER_FILES.md`)

### Краткосрочно (1-2 недели)
1. ⬆️ Настроить мониторинг (CPU, RAM, диск)
2. ⬆️ Оптимизировать процессы для новых ресурсов

### Долгосрочно (1-3 месяца)
1. ⬆️ Рассмотреть апгрейд до 4 vCPU + 8 ГБ RAM (если будет рост нагрузки)
2. ⬆️ Настроить автоматическое масштабирование

## Стоимость апгрейда

Обычно апгрейд с 1/1/20 до 2/2/20 стоит **+50-100%** от текущего тарифа.

**Пример**: Если текущий тариф 500₽/мес, то апгрейд будет ~750-1000₽/мес.

## Вывод

✅ **Апгрейд выполнен!** Текущие характеристики (2 vCPU + 4 ГБ RAM) **достаточны** для стабильной работы:
- Flask приложением
- Worker процессами (Playwright)
- Сборкой фронтенда
- Обработкой запросов

**Рекомендация**: После апгрейда **перезапустить все процессы** для использования новых ресурсов.

