# Причины неудовлетворительных результатов парсинга (0904017c, Оливер)

**Дата анализа:** 18.02.2026  
**Бизнес:** Оливер (org_id 203293742306)  
**Debug bundle:** `yandex_6620421e-527a-45a1-8001-16822b87d01c_0904017c-fcb7-440d-af17-ab6cc44f56e7_20260218_100414`

---

## Почему прямая ссылка на компанию не спасает?

**Прямая ссылка помогает** — API `search?business_oid=203293742306` возвращает org-специфичные данные. В ответе есть:
- title, address, categories ✅ (мы извлекаем)
- **phones**: `+7 (962) 684-69-80`, `+7 (921) 903-24-76` ❌ (не извлекаем)
- **urls**: `https://oliver-ulitsa-savushkina.clients.site/` ❌ (не извлекаем)
- **ratingData**: `ratingValue: 0`, `reviewCount: 0` — в search API рейтинг приходит как 0

**Почему всё равно пусто:**
1. **Phone, site** — в `_extract_search_api_business()` мы не извлекаем `phones` и `urls`. Эти поля берём только из location-info (LOCATION_INFO_SAFE_FIELDS).
2. **Rating** — в search API для этого бизнеса `ratingValue: 0`. Реальный рейтинг (4.x) есть только в location-info.
3. **location-info** — это **API карты**, а не организации. Он вызывается с параметрами `center` и `zoom` из текущего viewport. Прямая org-ссылка на него не влияет: при zoom 2 карта отдаёт данные по видимой области (вся планета), а не по нашей организации.

**Вывод:** Нужно добавить извлечение `phones` и `urls` из search API. Рейтинг по-прежнему придётся брать из location-info (или из среднего по отзывам), т.к. в search API он 0.

---

## 1. Пустой рейтинг (и phone, site, hours)

### Причина: Карта уехала на мировую карту + все location-info отклонены

**Факты:**
- `request_url`: `ll=30.219413,59.987283&z=13` (СПб) — исходный URL правильный
- `final_url`: `ll=-123.101319,-3.537040&z=2` — карта на мировом масштабе (zoom 2)
- В `last_10_json_urls` первый URL — location-info с `center=-123.101319,-3.537040&zoom=2`
- В `page.html` видно `data-z="2"` — карта отрендерилась на zoom 2

**Почему location-info отклонён:**
- API `location-info` возвращает данные по **видимой области карты**
- При zoom 2 видна вся планета — ответ содержит сотни организаций (первый ответ ~4.7 MB)
- `_is_location_info_org_bound()` проверяет, что в JSON есть `org_id` (203293742306)
- Варианты отказа:
  1. **Лимит 50 000 узлов** — в 4.7 MB JSON может быть >50k узлов, обход прерывается до нахождения org_id
  2. **Структура ответа** — org может быть в `toponymSearchResult` (топонимы), а не в формате `oid=` или `id`
  3. **Порядок ответов** — последний location-info (с center=-123,-3) точно не org-bound; более ранний с center=30.22,59.99 мог бы быть, но при итерации все отклоняются

**Цепочка:**
1. Переход на вкладку «Цены» → URL меняется на `/prices/`
2. Карта «уезжает» (баг/особенность Яндекс.Карт при смене вкладки)
3. ll,z сохраняются **до** клика на «Цены», но возврат на overview может использовать уже изменённый URL
4. Либо карта уехала **до** сохранения ll,z (например, при клике на Фото/Новости)

---

## 2. Услуги: 1 вместо 36 (исправлено)

### Причина: Баг в API `get_map_parses`

**Было:** `products_count = _len(rd.get("products"))` — считалось число категорий (1 блок «Другое»)

**Структура:** `products = [{"category": "Другое", "items": [36 услуг]}]` → `len(products) == 1`

**Исправление:** Добавлена `_products_count()`, считающая сумму `len(items)` по всем категориям.

---

## 3. Новости: 0 (в данных 7 постов)

### Причина: `_is_posts_data()` не распознаёт ответ getPosts

**Структура ответа getPosts:**
```json
{
  "data": {
    "count": 7,
    "items": [
      {"content": "...", "text": "...", "publicationTime": 1765817340026, ...}
    ]
  }
}
```

**Проблема:** `_is_posts_data()` проверяет только верхний уровень:
```python
return any(field in json_data for field in ['posts', 'publications', 'news', 'items'])
```
У `json_data` есть ключ `"data"`, а `"items"` лежит внутри `json_data["data"]`, поэтому условие не выполняется.

**Следствие:** Блок `elif self._is_posts_data(json_data)` не срабатывает, `_extract_posts()` не вызывается, новости не извлекаются.

---

## 4. Фото: 0 (в API 64 фото)

### Причина: Нет обработчика для getByBusinessId

**Структура ответа getByBusinessId:**
```json
{
  "data": [
    {"id": "urn:...", "url": "https://...", "width": 959, "height": 1280, ...},
    ...
  ]
}
```

**Проблема:** В `_extract_data_from_responses` нет ветки для:
- `getByBusinessId` в URL
- `photos` в URL

Ответ getByBusinessId не попадает ни под:
- fetchReviews
- fetchGoods/prices/goods/search/catalog
- _is_organization_data (нет полей name, address, rating и т.п.)
- _is_reviews_data
- _is_posts_data (нет posts/items на верхнем уровне)

**Следствие:** Фото из API не извлекаются. Используется только `photos_count` из текста вкладки (64), но массив `photos` остаётся пустым.

---

## 5. Карта уезжает на мировую

### Возможные причины

1. **Клик на «Цены»** — URL переходит на `/prices/`, карта может менять viewport
2. **Сохранение ll,z** — выполняется в `current_before_services = page.url` **перед** кликом на «Цены». Если к этому моменту карта уже сдвинулась (например, при скролле Фото/Новостей), ll,z будут неверными
3. **Возврат на overview** — `page.goto(overview_url_for_return)` использует `_build_overview_url(initial_url, ll, z)`. Если ll,z неправильные, возврат ведёт на мировую карту
4. **Порядок вкладок** — скрипт кликает: Обзор → Фото → Новости → Цены. Возможно, при клике на Фото или Новости карта уже меняется

---

## Рекомендуемые исправления

| # | Проблема | Решение |
|---|----------|---------|
| 1 | Рейтинг пустой | Сохранять ll,z при **первой** загрузке overview (до любых кликов по вкладкам). Увеличить лимит узлов в `_is_location_info_org_bound` для больших ответов или добавить проверку по `center` в URL location-info |
| 2 | Услуги | ✅ Исправлено (`_products_count`) |
| 3 | Новости | Расширить `_is_posts_data()`: проверять также `json_data.get("data")` на наличие posts/items |
| 4 | Фото | Добавить обработку URL с `getByBusinessId` или `photos`: извлекать массив из `data` и писать в `data['photos']` |
| 5 | Карта | Сохранять ll,z сразу после `page.goto(url)` (до любых кликов). При возврате с /prices/ использовать только эти сохранённые координаты |
| 6 | Phone, site из search API | Добавить в `_extract_search_api_business()` извлечение `phones[0].number` и `urls[0]` — они есть в org-специфичном ответе и не зависят от карты |
