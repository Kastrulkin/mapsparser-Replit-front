#!/usr/bin/env python3
"""
Скрипт для добавления "Стратегии успеха для Салона красоты" в базу данных
"""
import sys
import uuid
import json
from database_manager import DatabaseManager

# Данные для beauty_salon
BEAUTY_SALON_DATA = {
    "type_key": "beauty_salon",
    "label": "Салон красоты",
    "description": "Салон красоты с полным спектром услуг: парикмахерская, маникюр, косметология, массаж, СПА. Интеграция с BeautyBot.pro для автоматизации и локального продвижения",
    "stages": [
        {
            "stage_number": 1,
            "title": "Фундамент",
            "description": "Создание базовых профилей на геосервисах и сбор первых отзывов для локальной видимости",
            "goal": "Получить первые 10 отзывов и рейтинг 4.5+, обеспечить 100% заполненность карточек",
            "expected_result": "Увеличение показов на 20%, первые 20 переходов с карт в неделю",
            "duration": "1-2 недели",
            "tasks": [
                "Заполнить профиль на картах на 100%: адрес, телефон, фото, услуги, прайс",
                "Добавьте идентичную информацию на другие доступные в регионе карты",
                "Загрузить минимум 7 профессиональных фото: фасад, интерьер, работы мастеров",
                "Попросить 10 лояльных клиентов оставить отзыв через QR-код или ссылку",
                "Добавить ссылки на соцсети, сайт, виджет онлайн-записи"
            ]
        },
        {
            "stage_number": 2,
            "title": "Оптимизация видимости",
            "description": "Оптимизация геокарточек, запуск виджетов записи, управление отзывами",
            "goal": "Войти в Топ-3 локального поиска, получить 20+ переходов с карт",
            "expected_result": "CTR ≥5%, первые клиенты из геосервисов, рейтинг ≥4.6★",
            "duration": "2-3 недели",
            "tasks": [
                "Добавить полный прайс-лист, панорамы интерьера, видео работ в карточки",
                "Подключить виджет онлайн-записи (YCLIENTS, BeautyBot.pro) на все карты",
                "Настроить автоматический сбор отзывов после визита через SMS/Telegram",
                "Отвечать на все отзывы в течение 24 часов (благодарность + предложение)",
                "Добавить 10 новых фото/видео в карточки (улучшает позицию в выдаче)"
            ]
        },
        {
            "stage_number": 3,
            "title": "Автоматизация процессов",
            "description": "Внедрение CRM и базовая автоматизация клиентских коммуникаций",
            "goal": "Централизовать клиентскую базу, автоматизировать запись и напоминания",
            "expected_result": "80% заполненность базы, время ответа <2 часа, no-show <20%",
            "duration": "1-2 недели",
            "tasks": [
                "Выбрать и внедрить CRM (YCLIENTS, Rubitime, Beauty Pro, 1C:Салон, BeautyBot.pro)",
                "Мигрировать существующую клиентскую базу в CRM",
                "Настроить автоматические SMS/Telegram-напоминания за 24 часа до визита",
                "Создать шаблоны первичного ответа на заявку (менее 5 минут)",
                "Обучить персонал работе с CRM (2-3 обучающих сессии)"
            ]
        },
        {
            "stage_number": 4,
            "title": "Автоматизация коммуникаций и боты",
            "description": "Запуск чат-ботов, голосовых роботов, автоматических рассылок через BeautyBot.pro",
            "goal": "Снизить no-show с 30-40% до 10-15%, автоматизировать 60% входящих запросов",
            "expected_result": "Время ответа <30 мин, сокращение отказов на 25-30%, освобождение админа на 5+ часов/неделю",
            "duration": "2-3 недели",
            "tasks": [
                "Подключить BeautyBot.pro или Бьюти Бот для WhatsApp/Telegram",
                "Создать 7 сценариев для чат-бота: приветствие, запись, подтверждение, спасибо, повторный визит, отзыв, скидки",
                "Интегрировать бота с CRM для автоматической передачи заявок и синхронизации",
                "Настроить голосовой робот для подтверждения записей",
                "Протестировать на 100 клиентах, собрать отзывы, доработать сценарии"
            ]
        },
        {
            "stage_number": 5,
            "title": "Оптимизация монетизации",
            "description": "Анализ услуг, переработка прайс-листа, выявление маржинальных точек",
            "goal": "Увеличить средний чек на 15-25%, маржу на ключевых услугах на 10-15%",
            "expected_result": "Выявлены топ-3 прибыльных услуг, убыточные оптимизированы, цены пересмотрены",
            "duration": "2-3 недели",
            "tasks": [
                "Проанализировать CRM-данные: частота услуг, цена, себестоимость, маржа",
                "Выявить топ-3 популярных и топ-3 маржинальных услуг",
                "Пересчитать себестоимость каждой услуги (материалы, время, аренда)",
                "Повысить цены на 5-10% на высокомаржинальные услуги",
                "Снять или переориентировать 2-3 убыточные услуги"
            ]
        },
        {
            "stage_number": 6,
            "title": "Апсейл и кросс-селл услуг",
            "description": "Создание матрицы дополнительных продаж к каждой услуге, обучение персонала",
            "goal": "Увеличить средний чек на 20-35% через дополнительные услуги",
            "expected_result": "30% клиентов принимают апсейл-предложения, выручка +25-40%",
            "duration": "2-3 недели",
            "tasks": [
                "Разработать матрицу кросс-селла: к каждой услуге 2-3 дополнительные",
                "ПРИМЕРЫ МАТРИЦЫ: Маникюр → Укрепление (+15%), Дизайн (+25%); Окрашивание → Ботокс (+25%), Кератин (+30%); Стрижка → Укладка (+20%), Маска (+15%); Педикюр → Медицинский педикюр (+50%), Массаж ног (+30%); Косметология → Пилинг (+30%), Маска (+20%); Массаж → Косметология (+25%), Маникюр (+20%)",
                "Создать 7 комбо-пакетов: 'Спа-день', 'Красивая невеста', 'Омоложение', 'Выходной', 'Молодость', 'Восстановление', 'Полный детокс'",
                "Провести 2 тренинга для персонала: техника апсейла, психология предложения, готовые скрипты",
                "Внедрить в CRM подсказки для администратора и мастера при записи и во время процедуры"
            ]
        },
        {
            "stage_number": 7,
            "title": "Локальные партнерства и холодный аутрич",
            "description": "Создание сети взаимовыгодных партнерств через холодные письма и встречи",
            "goal": "Получить 10-15 новых клиентов в месяц через партнеров",
            "expected_result": "3-5 активных партнеров, CAC -60% vs реклама, ROI >300%",
            "duration": "3-4 недели",
            "tasks": [
                "Составить карту соседей в радиусе 500м: фитнес-клубы, кофейни, магазины одежды, спа-центры, рестораны",
                "Отфильтровать целевых партнеров (бизнесы с аудиторией 300+ клиентов/месяц, маржа >30%)",
                "ОБРАЗЕЦ ХОЛОДНОГО ПИСЬМА: 'Hi [Имя], мы заметили, что ваши клиенты ищут услуги красоты. Наш салон может предложить им эксклюзивную скидку 15%. Ваши клиентки получат скидку 15%, вы получаете комиссию 5-10% от каждой привлеченной клиентки. Интересно обсудить?'",
                "Написать и отправить 20 персонализированных холодных писем",
                "Провести личные встречи с владельцами 5 наиболее перспективных партнеров",
                "Заключить соглашения о кросс-промо: взаимные скидки, печатные купоны, рекомендации в соцсетях",
                "Запустить 2 совместные акции: 'День красоты для членов фитнес-клуба', 'Пакет для постоянных посетителей кофейни'"
            ]
        },
        {
            "stage_number": 8,
            "title": "Креативные листовки и уличный маркетинг",
            "description": "Создание креативных листовок с историей салона и массовое распространение в целевых локациях",
            "goal": "Привести 15-25 клиентов с улицы, создать локальный buzz",
            "expected_result": "20-25% конверсия раздача→визит, узнаваемость бренда в районе",
            "duration": "2-3 недели",
            "tasks": [
                "Разработать концепцию КРЕАТИВНОЙ листовки: история салона + фото основательницы + примеры работ (до/после) + QR-код",
                "Создать 3-4 дизайн-варианта листовок (A6 размер, 10x15см) для разных аудиторий",
                "Напечатать 500-1000 листовок на качественной мелованной бумаге",
                "Идентифицировать целевые точки раздачи: фитнес-клубы, кофейни, станции метро, парки, ЖК в радиусе 1км",
                "Организовать 2-3 дня раздачи с мастерами (в фирменных футболках): доп. скидка 25% за фото с листовкой",
                "Отслеживать конверсию в CRM: % пришедших клиентов, % ставших постоянными"
            ]
        },
        {
            "stage_number": 9,
            "title": "Допродажи товаров и FMCG",
            "description": "Начало продаж косметических товаров, создание дополнительного дохода",
            "goal": "Добавить 10-15% к выручке, 20%+ клиентов приобретают товар",
            "expected_result": "Средний чек +10-15%, маржа на товары 50-60%, база для расширения на маркетплейсы",
            "duration": "2-3 недели",
            "tasks": [
                "Провести аудит: какие товары просят клиенты? Какие услуги требуют домашнего ухода?",
                "Выбрать поставщика косметики: премиум (Kerastase, Olaplex) ИЛИ мас-маркет (Nature Republic)",
                "Начать минимально: TOP-6 ТОВАРОВ: Шампуни, Кондиционеры, Маски для волос, Топы/базы для ногтей, Масла, Сыворотки",
                "Создать МИНИ-ВИТРИНУ в салоне: красиво оформленные полки у кассы, яркие ценники, образцы для тестирования",
                "Обучить мастеров рекомендовать товары: техника 'натурального предложения' + комиссия 10% от продажи",
                "Интегрировать товары в CRM: отслеживать, какие товары к каким услугам идут лучше"
            ]
        },
        {
            "stage_number": 10,
            "title": "Социальные сети и контент-маркетинг",
            "description": "Создание органического трафика и сообщества через регулярный контент",
            "goal": "500-1000 подписчиков, 5-10 клиентов/месяц из соцсетей, узнаваемость бренда",
            "expected_result": "3%+ вовлеченность, органический рост, активное сообщество",
            "duration": "4-6 недель",
            "tasks": [
                "Создать контент-план на 30 дней (Instagram, TikTok, VK): фото ДО/ПОСЛЕ, обучающие видео, истории мастеров, конкурсы",
                "Установить расписание постов: Instagram/VK 4-5 постов/неделю, TikTok 5-7 видео/неделю, сторис ежедневно",
                "Создать постоянные РУБРИКИ: #МойТрансформ, #АнтиМифы, #МастерТур, #ОтзывКлиента, #Лайфхак, #ТреДня",
                "Организовать 1-2 коллаборации с микро-инфлюэнсерами в районе (3-10k подписчиков)",
                "Взаимодействовать с подписчиками: отвечать на комментарии в течение 2 часов, опросы еженедельно",
                "Использовать тренды: участвовать в челленджах, использовать популярные аудиодорожки"
            ]
        },
        {
            "stage_number": 11,
            "title": "Репутация и управление отзывами",
            "description": "Автоматизация сбора отзывов, управление репутацией, интеграция с ботами",
            "goal": "20 отзывов/месяц, рейтинг 4.6+★, привлечение +15-20% новых клиентов через отзывы",
            "expected_result": "Высокое социальное доказательство качества, лидерство по рейтингу в районе",
            "duration": "1-2 недели",
            "tasks": [
                "Подключить BeautyBot.pro для автоматического сбора отзывов через Telegram/WhatsApp после процедуры",
                "Настроить в CRM: сразу после визита клиент получает SMS/Telegram 'Оставьте отзыв и получите скидку 10% + бонус'",
                "Создать стандартные ШАБЛОНЫ ОТВЕТОВ на отзывы: благодарность на позитивные, извинение + решение на негативные",
                "На отрицательные отзывы: ВСЕГДА извиняться, показывать понимание, предлагать решение, взять контакт",
                "Отвечать на ВСЕ отзывы в течение 24 часов (улучшает видимость на картах на 20-30%)"
            ]
        },
        {
            "stage_number": 12,
            "title": "Программа лояльности и retention",
            "description": "Создание системы удержания клиентов, скидки за рефереалы, программа постоянного клиента",
            "goal": "Повторный визит 60%+ клиентов, средний lifetime value +40%",
            "expected_result": "Стабильный доход от постоянных клиентов, рост выручки на 30%",
            "duration": "2-3 недели",
            "tasks": [
                "Разработать программу лояльности: 'Каждый 10-й визит - скидка 30%' ИЛИ 'Система баллов: 1₽ = 1 балл, 100 баллов = 500₽'",
                "Создать программу РЕФЕРЕАЛОВ: 'Приведи подругу - получи 20% скидку + подруга получит 30% на первый визит'",
                "Автоматизировать НАПОМИНАНИЯ в CRM: отправлять SMS/Telegram за неделю до очередного визита",
                "Создать VIP-программу для топ-30% клиентов: подарки на ДР, первый доступ к новым услугам, закрытые вечеринки",
                "Интегрировать всё в CRM с отслеживанием: кто активен, кто не приходит 2+ месяца, кого 'пробудить'"
            ]
        },
        {
            "stage_number": 13,
            "title": "Email и SMS маркетинг",
            "description": "Запуск целевых рассылок, сегментация аудитории, автоматические сценарии",
            "goal": "25-30% open rate, 5-10% click rate, генерировать дополнительный доход через рассылки",
            "expected_result": "Новые клиенты из рассылок, повторные визиты, дополнительные услуги",
            "duration": "2-3 недели",
            "tasks": [
                "Собрать список email и номеров телефонов всех клиентов (согласие на рассылку при первой записи)",
                "Сегментировать аудиторию на 4 группы: Новые, Постоянные (3-10 визитов), VIP (10+), Неактивные (3+ месяца)",
                "Создать 5 АВТОМАТИЧЕСКИХ СЦЕНАРИЕВ: приветствие, спасибо после визита, напоминание, рефереал, возвращение неактивных",
                "Планировать ЕЖЕНЕДЕЛЬНЫЕ рассылки: Пн - предложение недели, Ср - обучающий контент, Пт - выходной бонус",
                "A/B тестирование: разные заголовки, времена отправки, предложения - отслеживать лучшие и масштабировать"
            ]
        },
        {
            "stage_number": 14,
            "title": "Корпоративные и групповые услуги",
            "description": "Предложение услуг компаниям, организация корпоративов, командообразующих событий",
            "goal": "Получить 2-3 постоянные корпоративные клиента, гарантированный месячный доход",
            "expected_result": "Корпоративные договоры, групповые бронирования, стабильный доход",
            "duration": "3-4 недели",
            "tasks": [
                "Идентифицировать компании-кандидаты в районе: IT, маркетинг, страховка, банки (50+ сотрудников, 70%+ женщины)",
                "Разработать корпоративное ПРЕДЛОЖЕНИЕ: скидка 20-25% на услуги, раз в месяц спа-пакет для группы 10+, корпоратив на выходных",
                "Написать письма HR-менеджерам с предложением корпоративного бенефита",
                "Организовать ПИЛОТНЫЙ 'День красоты компании': выездное обслуживание ИЛИ групповой визит с подарками",
                "Заключить контракты с 2-3 компаниями: минимум 50 процедур/месяц, счета с отсрочкой 30 дней"
            ]
        },
        {
            "stage_number": 15,
            "title": "SEO и локальный контент-блог",
            "description": "Создание блога, оптимизация под поисковики, локальный SEO для привлечения органического трафика",
            "goal": "Органический трафик с Google, позиция по ключевым запросам, авторитет",
            "expected_result": "10-20 визитов/месяц из поиска, трафик растет месяц за месяцем",
            "duration": "4-8 недель",
            "tasks": [
                "Провести SEO-исследование ключевых слов: 'маникюр [район]', 'окрашивание волос СПб', 'лучший косметолог рядом', 'салон красоты рядом со мной'",
                "Оптимизировать на сайте: добавить ключевые слова в заголовки H1, описания услуг, метаописания, URL",
                "Создать раздел БЛОГА с полезными статьями: уход за волосами, тренды маникюра, подготовка к косметологии, выбор цвета волос",
                "Публиковать 2-3 статьи/месяц минимум 1000-1500 слов каждая (с картинками, структурой, ссылками)",
                "Получить 3-5 обратных ссылок: попросить партнеров упоминать вас, написать в местные бизнес-ресурсы"
            ]
        },
        {
            "stage_number": 16,
            "title": "Постоянное улучшение, анализ и оптимизация",
            "description": "Регулярный анализ всех метрик, A/B тестирование, оптимизация слабых мест",
            "goal": "Рост выручки +10-15% в месяц, постоянное совершенствование процессов",
            "expected_result": "Стабильный рост всех показателей, минимизация убытков, максимизация прибыли",
            "duration": "Постоянно",
            "tasks": [
                "Настроить ЕЖЕНЕДЕЛЬНЫЕ ОТЧЕТЫ: трафик, новые клиенты, выручка, no-show, средний чек, маржа, загруженность мастеров",
                "Проводить ЕЖЕМЕСЯЧНЫЕ совещания с командой: что сработало? Что не сработало? Какие идеи протестировать?",
                "ЕЖЕМЕСЯЧНО тестировать 1 НОВУЮ ИДЕЮ: новая услуга, новый канал маркетинга, новое предложение, новый партнер",
                "ЕЖЕКВАРТАЛЬНО пересмотреть СТРАТЕГИЮ: анализ конкурентов, новые тренды, коррекция целей, планирование этапов",
                "ИНВЕСТИРОВАТЬ в развитие: минимум 10% от дополнительного дохода идет на маркетинг, обучение, расширение"
            ]
        }
    ]
}

def add_beauty_salon_strategy():
    """Добавление стратегии для салона красоты"""
    db = DatabaseManager()
    try:
        cursor = db.conn.cursor()
        
        # Проверяем, есть ли уже такой тип
        cursor.execute("SELECT id FROM BusinessTypes WHERE type_key = ?", (BEAUTY_SALON_DATA['type_key'],))
        existing_type = cursor.fetchone()
        
        if existing_type:
            print(f"⚠️ Тип '{BEAUTY_SALON_DATA['type_key']}' уже существует. Удаляем старые данные...")
            business_type_id = existing_type[0]
            # Удаляем старые этапы
            cursor.execute("DELETE FROM GrowthStages WHERE business_type_id = ?", (business_type_id,))
        else:
            # Создаем новый тип бизнеса
            business_type_id = str(uuid.uuid4())
            cursor.execute("""
                INSERT INTO BusinessTypes (id, type_key, label, description, is_active)
                VALUES (?, ?, ?, ?, 1)
            """, (
                business_type_id,
                BEAUTY_SALON_DATA['type_key'],
                BEAUTY_SALON_DATA['label'],
                BEAUTY_SALON_DATA['description']
            ))
            print(f"✅ Создан тип бизнеса: {BEAUTY_SALON_DATA['label']} ({business_type_id})")
        
        # Добавляем этапы
        for stage_data in BEAUTY_SALON_DATA['stages']:
            stage_id = str(uuid.uuid4())
            tasks_json = json.dumps(stage_data['tasks'])
            
            cursor.execute("""
                INSERT INTO GrowthStages (
                    id, business_type_id, stage_number, title, description,
                    goal, expected_result, duration, is_permanent, tasks
                )
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0, ?)
            """, (
                stage_id,
                business_type_id,
                stage_data['stage_number'],
                stage_data['title'],
                stage_data['description'],
                stage_data['goal'],
                stage_data['expected_result'],
                stage_data['duration'],
                tasks_json
            ))
            print(f"   ✅ Этап {stage_data['stage_number']}: {stage_data['title']}")
        
        db.conn.commit()
        print(f"\n✅ Стратегия для '{BEAUTY_SALON_DATA['label']}' успешно добавлена!")
        print(f"   Добавлено этапов: {len(BEAUTY_SALON_DATA['stages'])}")
        
    except Exception as e:
        db.conn.rollback()
        print(f"❌ Ошибка: {e}")
        import traceback
        traceback.print_exc()
    finally:
        db.close()

if __name__ == "__main__":
    add_beauty_salon_strategy()
