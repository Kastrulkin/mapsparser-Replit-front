# Настройка внешних интеграций (Яндекс.Бизнес, Google Business, 2ГИС)

## Общая информация

Система поддерживает интеграцию с личными кабинетами внешних платформ для автоматической синхронизации:
- **Отзывов** (рейтинг, текст, автор, ответы компании)
- **Статистики** (показы, клики, действия, рейтинг, количество отзывов)

Данные авторизации (cookies, токены) **шифруются** перед сохранением в БД с помощью библиотеки `cryptography`.

## Требования

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
   Особенно важна библиотека `cryptography>=41.0.0` для шифрования.

2. Настройте переменные окружения в `.env`:
   ```bash
   # Обязательно для продакшена: случайная строка 32+ символов
   EXTERNAL_AUTH_SECRET_KEY=ваш_секретный_ключ_для_шифрования_минимум_32_символа
   
   # Для тестирования без реальных запросов (используются демо-данные)
   YANDEX_BUSINESS_FAKE=0  # 0 = реальные запросы, 1 = демо-данные
   ```

## Яндекс.Бизнес

### Какие данные нужны

Для подключения личного кабинета Яндекс.Бизнес вам понадобятся:

1. **Cookies из браузера** (обязательно):
   - После входа в личный кабинет `https://business.yandex.ru/`
   - Откройте DevTools (F12) → вкладка "Application" (Chrome) или "Storage" (Firefox)
   - Найдите раздел "Cookies" → выберите домен `business.yandex.ru` или `yandex.ru`
   - Скопируйте все cookies в формате одной строки:
     ```
     yandexuid=1234567890123456789; Session_id=abc123def456ghi789; yandex_login=user@example.com; ...
     ```

2. **ID организации** (опционально, но рекомендуется):
   - Можно найти в URL кабинета: `https://business.yandex.ru/organizations/{org_id}/...`
   - Или в настройках организации в кабинете

3. **Название организации** (опционально):
   - Для удобства идентификации в админской панели

### Как подключить

1. Войдите в **админскую панель** (только для суперадмина)
2. Перейдите в раздел **"Пользователи и бизнесы"**
3. Найдите нужный бизнес и нажмите кнопку **"Настройки"**
4. В модальном окне заполните форму **"Яндекс.Бизнес"**:
   - **ID организации**: вставьте `external_id` (если известен)
   - **Название**: вставьте название организации (опционально)
   - **Cookies / Токен сессии**: вставьте скопированные cookies
5. Нажмите **"Сохранить"**

### Формат данных

**Cookies** должны быть в формате одной строки, разделённые точкой с запятой:
```
yandexuid=1234567890123456789; Session_id=abc123def456ghi789; yandex_login=user@example.com; yp=1234567890.1234567890.1234567890; yandex_gid=123; ...
```

**Важно:**
- Cookies должны быть актуальными (не истёкшими)
- После истечения сессии нужно обновить cookies в админской панели
- Система автоматически шифрует cookies перед сохранением в БД

### Тестирование

Для тестирования без реальных запросов к кабинету:

1. Установите в `.env`: `YANDEX_BUSINESS_FAKE=1`
2. В этом режиме воркер будет использовать **демо-данные**:
   - Один демо-отзыв с рейтингом 5
   - Демо-статистика (100 показов, 10 кликов, 5 действий, рейтинг 4.8, 123 отзыва)
3. Данные авторизации всё равно можно указать (они будут сохранены, но не использованы)

### Синхронизация

Воркер `yandex_business_sync_worker.py` автоматически:
1. Загружает все активные аккаунты Яндекс.Бизнес из БД
2. Расшифровывает cookies для каждого аккаунта
3. Выполняет HTTP-запросы к кабинету (или использует демо-данные, если `YANDEX_BUSINESS_FAKE=1`)
4. Сохраняет отзывы в таблицу `ExternalBusinessReviews`
5. Сохраняет статистику в таблицу `ExternalBusinessStats`
6. Обновляет `last_sync_at` и `last_error` в `ExternalBusinessAccounts`

**Запуск воркера:**
```bash
python src/yandex_business_sync_worker.py
```

## 2ГИС

### Какие данные нужны

Аналогично Яндекс.Бизнес:
1. **Cookies из браузера** после входа в личный кабинет 2ГИС
2. **ID организации** (опционально)
3. **Название организации** (опционально)

### Как подключить

Аналогично Яндекс.Бизнес через админскую панель → кнопка "Настройки" → форма "2ГИС".

## Google Business Profile

Настраивается пользователем в личном кабинете через OAuth (см. компонент `ExternalIntegrations`).

## Безопасность

- Все данные авторизации (cookies, токены) **шифруются** перед сохранением в БД
- Используется библиотека `cryptography` с алгоритмом Fernet (symmetric encryption)
- Ключ шифрования берётся из переменной окружения `EXTERNAL_AUTH_SECRET_KEY`
- **ВАЖНО**: Для продакшена используйте случайную строку длиной 32+ символов!

## Устранение неполадок

### Ошибка "Не удалось расшифровать auth_data"
- Проверьте, что `EXTERNAL_AUTH_SECRET_KEY` установлен в `.env`
- Убедитесь, что ключ не изменился после сохранения данных (иначе расшифровка не сработает)

### Ошибка "Ошибка запроса к кабинету"
- Проверьте, что cookies актуальны (не истёкшие)
- Убедитесь, что cookies скопированы полностью
- Попробуйте обновить cookies в админской панели

### Демо-данные вместо реальных
- Проверьте значение `YANDEX_BUSINESS_FAKE` в `.env` (должно быть `0` для реальных запросов)
- Убедитесь, что воркер запущен и обрабатывает аккаунты

