#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –Ω–µ–Ω—É–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –ë–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∫–µ—à-—Ñ–∞–π–ª—ã

set -e

echo "üßπ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–Ω—É–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
echo "========================================"
echo ""

cd /root/mapsparser-Replit-front || {
    echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    exit 1
}

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –î–û –æ—á–∏—Å—Ç–∫–∏
echo "üìä –†–∞–∑–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ –î–û –æ—á–∏—Å—Ç–∫–∏:"
du -sh . 2>/dev/null
echo ""

# 1. –û—á–∏—Å—Ç–∫–∞ Python –∫–µ—à–µ–π
echo "üóëÔ∏è  1. –û—á–∏—Å—Ç–∫–∞ Python –∫–µ—à–µ–π (__pycache__, *.pyc)..."
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
find . -type f -name "*.pyc" -delete 2>/dev/null || true
find . -type f -name "*.pyo" -delete 2>/dev/null || true
echo "   ‚úÖ Python –∫–µ—à–∏ —É–¥–∞–ª–µ–Ω—ã"
echo ""

# 2. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ –ë–î (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
echo "üóëÔ∏è  2. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ –ë–î..."
if [ -d "db_backups" ]; then
    cd db_backups
    BACKUP_COUNT=$(ls -1 *.backup 2>/dev/null | wc -l)
    if [ "$BACKUP_COUNT" -gt 5 ]; then
        # –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5
        ls -t *.backup 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
        echo "   ‚úÖ –£–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5)"
    else
        echo "   ‚ÑπÔ∏è  –ë—ç–∫–∞–ø–æ–≤ –º–µ–Ω—å—à–µ 5, –Ω–∏—á–µ–≥–æ –Ω–µ —É–¥–∞–ª–µ–Ω–æ"
    fi
    cd ..
fi
echo ""

# 3. –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
echo "üóëÔ∏è  3. –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤..."
# –õ–æ–≥–∏ –ø—Ä–æ–µ–∫—Ç–∞
find . -type f -name "*.log" -not -path "./.git/*" -delete 2>/dev/null || true
# –õ–æ–≥–∏ –≤ /tmp
> /tmp/seo_main.out 2>/dev/null || true
> /tmp/seo_worker.out 2>/dev/null || true
echo "   ‚úÖ –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã"
echo ""

# 4. –û—á–∏—Å—Ç–∫–∞ node_modules/.cache (–µ—Å–ª–∏ –µ—Å—Ç—å)
echo "üóëÔ∏è  4. –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–µ–π npm..."
if [ -d "frontend/node_modules/.cache" ]; then
    rm -rf frontend/node_modules/.cache
    echo "   ‚úÖ –£–¥–∞–ª–µ–Ω node_modules/.cache"
fi
if [ -d "frontend/.vite" ]; then
    rm -rf frontend/.vite
    echo "   ‚úÖ –£–¥–∞–ª–µ–Ω frontend/.vite"
fi
npm cache clean --force 2>/dev/null || true
echo ""

# 5. –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üóëÔ∏è  5. –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
# –í—Ä–µ–º–µ–Ω–Ω—ã–µ JSON —Ñ–∞–π–ª—ã —Ç–µ—Å—Ç–æ–≤
find . -type f -name "test_*.json" -not -path "./.git/*" -delete 2>/dev/null || true
# –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –∫–æ—Ä–Ω–µ
rm -f tmp 2>/dev/null || true
rm -f *.tmp 2>/dev/null || true
echo "   ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã"
echo ""

# 6. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–±–æ—Ä–æ–∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ)
echo "üóëÔ∏è  6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–æ–∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
if [ -d "frontend/dist" ]; then
    DIST_SIZE=$(du -sh frontend/dist 2>/dev/null | cut -f1)
    echo "   ‚ÑπÔ∏è  –†–∞–∑–º–µ—Ä frontend/dist: $DIST_SIZE (–æ—Å—Ç–∞–≤–ª—è–µ–º)"
fi
echo ""

# 7. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö uploads (–µ—Å–ª–∏ –µ—Å—Ç—å)
echo "üóëÔ∏è  7. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫..."
if [ -d "uploads" ]; then
    # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
    find uploads -type f -mtime +30 -delete 2>/dev/null || true
    echo "   ‚úÖ –£–¥–∞–ª–µ–Ω—ã —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π"
fi
echo ""

# 8. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –º–µ—Å—Ç–∞
echo "üìä –¢–æ–ø-10 —Å–∞–º—ã—Ö –±–æ–ª—å—à–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π:"
du -sh */ .* 2>/dev/null | sort -h | tail -10
echo ""

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –ü–û–°–õ–ï –æ—á–∏—Å—Ç–∫–∏
echo "üìä –†–∞–∑–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ –ü–û–°–õ–ï –æ—á–∏—Å—Ç–∫–∏:"
du -sh . 2>/dev/null
echo ""

echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "   - –ï—Å–ª–∏ node_modules –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π (>500MB), –º–æ–∂–Ω–æ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:"
echo "     cd frontend && rm -rf node_modules && npm install"
echo "   - –ï—Å–ª–∏ .git –±–æ–ª—å—à–æ–π, –º–æ–∂–Ω–æ –ø–æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)"
echo "   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –ë–î: ls -lh src/reports.db"

