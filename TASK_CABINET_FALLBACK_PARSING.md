# –ó–∞–¥–∞—á–∞: –ü–∞—Ä—Å–∏–Ω–≥ –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ –∫–∞–∫ fallback –¥–ª—è –Ω–µ—É—Å–ø–µ—à–Ω–æ–≥–æ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞

**–î–∞—Ç–∞:** 2025-01-03  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π  
**–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:** –ö–æ–¥–µ—Ä

---

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—É–±–ª–∏—á–Ω—ã–µ –ø–∞—Ä—Å–µ—Ä—ã (interception –∏ legacy) –º–æ–≥—É—Ç –Ω–µ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑-–∑–∞:
- –ö–∞–ø—á–∏
- –ë–ª–æ–∫–∏—Ä–æ–≤–æ–∫ IP
- –ù–µ–ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–æ—Ç–∑—ã–≤—ã –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
- –û—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞

–ï—Å–ª–∏ —É –±–∏–∑–Ω–µ—Å–∞ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –Ø–Ω–¥–µ–∫—Å.–ë–∏–∑–Ω–µ—Å, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –¥–ª—è –¥–æ–ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö.

---

## –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ—Ç–∏–π —Ç–∏–ø –∑–∞–¥–∞—á–∏ –≤ ParseQueue: `task_type = 'parse_cabinet_fallback'`

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ—Å–ª–µ –Ω–µ—É—Å–ø–µ—à–Ω–æ–≥–æ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, –µ—Å—Ç—å –ª–∏ —É –±–∏–∑–Ω–µ—Å–∞ –∞–∫–∫–∞—É–Ω—Ç –≤ `ExternalBusinessAccounts`
2. –ï—Å–ª–∏ –µ—Å—Ç—å ‚Üí —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–¥–∞—á—É `parse_cabinet_fallback` –≤ ParseQueue
3. Worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ `YandexBusinessParser`
4. –î–æ–ø–æ–ª–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ö–µ–º–∞ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –ø–∞—Ä—Å–µ—Ä–æ–≤:

```
1. –ü—É–±–ª–∏—á–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ (parse_card)
   ‚îú‚îÄ Interception –ø–∞—Ä—Å–µ—Ä (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1)
   ‚îÇ  ‚îú‚îÄ –ü–µ—Ä–µ—Ö–≤–∞—Ç API ‚Üí –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
   ‚îÇ  ‚îî‚îÄ Fallback: HTML –ø–∞—Ä—Å–∏–Ω–≥ (–µ—Å–ª–∏ API –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)
   ‚îî‚îÄ Legacy –ø–∞—Ä—Å–µ—Ä (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2, –µ—Å–ª–∏ interception –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
   ‚îú‚îÄ –î–∞–Ω–Ω—ã–µ –ø–æ–ª–Ω—ã–µ? ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å, –∑–∞–≤–µ—Ä—à–∏—Ç—å
   ‚îî‚îÄ –î–∞–Ω–Ω—ã–µ –Ω–µ–ø–æ–ª–Ω—ã–µ/–æ—à–∏–±–∫–∞/–∫–∞–ø—á–∞? ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∫–∞–±–∏–Ω–µ—Ç–∞

3. Fallback —á–µ—Ä–µ–∑ –∫–∞–±–∏–Ω–µ—Ç (parse_cabinet_fallback)
   ‚îî‚îÄ –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç –≤ ExternalBusinessAccounts
      ‚îî‚îÄ YandexBusinessParser ‚Üí –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
```

---

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ "–Ω–µ—É—Å–ø–µ—à–Ω–æ–≥–æ" –ø–∞—Ä—Å–∏–Ω–≥–∞

**–ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–¥–∞—á—É fallback:**

1. **–ö–∞–ø—á–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞:**
   - `card_data.get("error") == "captcha_detected"`
   - –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ = `"captcha"`

2. **–ù–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
   - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ (`title` –∏–ª–∏ `overview.title`)
   - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∞–¥—Ä–µ—Å (`address`)
   - –ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ (`reviews` –ø—É—Å—Ç–æ–π –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç), –Ω–æ –±–∏–∑–Ω–µ—Å –¥–æ–ª–∂–µ–Ω –∏—Ö –∏–º–µ—Ç—å
   - –ù–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–µ—Å–ª–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è)

3. **–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:**
   - `card_data.get("error")` –Ω–µ –ø—É—Å—Ç–æ–µ
   - –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ

4. **–ü—É—Å—Ç—ã–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ–ª—è:**
   - –†–µ–π—Ç–∏–Ω–≥ = 0 –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–µ—Å–ª–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è)
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ = 0 (–µ—Å–ª–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è –±–æ–ª—å—à–µ)

---

## –ü–ª–∞–Ω –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –≠—Ç–∞–ø 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞

**–§–∞–π–ª:** `src/worker.py` (—Å–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é)

```python
def _is_parsing_successful(card_data: dict, business_id: str = None) -> tuple[bool, str]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —É—Å–ø–µ—à–µ–Ω –ª–∏ –ø–∞—Ä—Å–∏–Ω–≥.
    
    Returns:
        (is_successful: bool, reason: str)
    """
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–ø—á—É
    if card_data.get("error") == "captcha_detected":
        return False, "captcha_detected"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫—É
    if card_data.get("error"):
        return False, f"error: {card_data.get('error')}"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–æ–ª–µ–π
    title = card_data.get('title') or card_data.get('overview', {}).get('title')
    address = card_data.get('address') or card_data.get('overview', {}).get('address')
    
    if not title:
        return False, "missing_title"
    
    if not address:
        return False, "missing_address"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å)
    reviews = card_data.get('reviews', [])
    if isinstance(reviews, dict):
        reviews = reviews.get('items', [])
    
    # –ï—Å–ª–∏ –±–∏–∑–Ω–µ—Å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –æ—Ç–∑—ã–≤—ã, –Ω–æ –∏—Ö –Ω–µ—Ç - —Å—á–∏—Ç–∞–µ–º –Ω–µ–ø–æ–ª–Ω—ã–º
    # (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ –ë–î, –µ—Å–ª–∏ —É –±–∏–∑–Ω–µ—Å–∞ –±—ã–ª–∏ –æ—Ç–∑—ã–≤—ã —Ä–∞–Ω–µ–µ)
    
    return True, "success"
```

---

### –≠—Ç–∞–ø 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –∫–∞–±–∏–Ω–µ—Ç–∞

**–§–∞–π–ª:** `src/worker.py` (—Å–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é)

```python
def _has_cabinet_account(business_id: str) -> tuple[bool, str]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É –±–∏–∑–Ω–µ—Å–∞ –∞–∫–∫–∞—É–Ω—Ç –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.
    
    Returns:
        (has_account: bool, account_id: str)
    """
    conn = get_db_connection()
    cursor = conn.cursor()
    
    try:
        cursor.execute("""
            SELECT id 
            FROM ExternalBusinessAccounts 
            WHERE business_id = ? 
              AND source = 'yandex_business' 
              AND is_active = 1
            LIMIT 1
        """, (business_id,))
        
        row = cursor.fetchone()
        if row:
            return True, row[0]
        return False, None
    finally:
        cursor.close()
        conn.close()
```

---

### –≠—Ç–∞–ø 3: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ parse_card

**–§–∞–π–ª:** `src/worker.py` (–∏–∑–º–µ–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `process_queue()`)

**–ü–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–∞—Ä—Ç—ã (—Å—Ç—Ä–æ–∫–∞ 127):**

```python
# –ü–æ—Å–ª–µ card_data = parse_yandex_card(queue_dict["url"])

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø–∞—Ä—Å–∏–Ω–≥–∞
is_successful, reason = _is_parsing_successful(card_data, business_id)

if not is_successful and business_id:
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞–±–∏–Ω–µ—Ç –¥–ª—è fallback
    has_account, account_id = _has_cabinet_account(business_id)
    
    if has_account:
        print(f"‚ö†Ô∏è –ü–∞—Ä—Å–∏–Ω–≥ –Ω–µ–ø–æ–ª–Ω—ã–π ({reason}), —Å–æ–∑–¥–∞—é –∑–∞–¥–∞—á—É fallback —á–µ—Ä–µ–∑ –∫–∞–±–∏–Ω–µ—Ç")
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É fallback
        fallback_task_id = str(uuid.uuid4())
        conn = get_db_connection()
        cursor = conn.cursor()
        
        try:
            cursor.execute("""
                INSERT INTO ParseQueue (
                    id, business_id, account_id, task_type, source,
                    status, user_id, url, created_at, updated_at
                )
                VALUES (?, ?, ?, 'parse_cabinet_fallback', 'yandex_business',
                        'pending', ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
            """, (fallback_task_id, business_id, account_id, queue_dict["user_id"], queue_dict["url"]))
            conn.commit()
            print(f"‚úÖ –°–æ–∑–¥–∞–Ω–∞ –∑–∞–¥–∞—á–∞ fallback: {fallback_task_id}")
        finally:
            cursor.close()
            conn.close()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∞—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–∞–∫ –æ–±—ã—á–Ω–æ, –Ω–æ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –Ω–µ–ø–æ–ª–Ω–æ–µ
```

---

### –≠—Ç–∞–ø 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ parse_cabinet_fallback

**–§–∞–π–ª:** `src/worker.py` (–∏–∑–º–µ–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `process_queue()`)

**–í –±–ª–æ–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–¥–∞—á (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 100):**

```python
elif task_type == "parse_cabinet_fallback":
    # Fallback –ø–∞—Ä—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ –∫–∞–±–∏–Ω–µ—Ç
    _process_cabinet_fallback_task(queue_dict)
    return
```

**–°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é:**

```python
def _process_cabinet_fallback_task(queue_dict: dict):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ fallback –ø–∞—Ä—Å–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ –∫–∞–±–∏–Ω–µ—Ç"""
    business_id = queue_dict.get("business_id")
    account_id = queue_dict.get("account_id")
    url = queue_dict.get("url")
    
    if not business_id or not account_id:
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ error
        conn = get_db_connection()
        cursor = conn.cursor()
        cursor.execute("""
            UPDATE ParseQueue 
            SET status = 'error', 
                error_message = '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç business_id –∏–ª–∏ account_id',
                updated_at = CURRENT_TIMESTAMP
            WHERE id = ?
        """, (queue_dict["id"],))
        conn.commit()
        conn.close()
        return
    
    try:
        from yandex_business_parser import YandexBusinessParser
        from auth_encryption import decrypt_auth_data
        import json
        
        # –ü–æ–ª—É—á–∞–µ–º auth_data
        db = DatabaseManager()
        cursor = db.conn.cursor()
        
        cursor.execute("""
            SELECT auth_data_encrypted, external_id 
            FROM ExternalBusinessAccounts 
            WHERE id = ? AND business_id = ?
        """, (account_id, business_id))
        account_row = cursor.fetchone()
        
        if not account_row:
            raise Exception("–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        auth_data_encrypted, external_id = account_row
        auth_data_plain = decrypt_auth_data(auth_data_encrypted)
        
        if not auth_data_plain:
            raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å auth_data")
        
        # –ü–∞—Ä—Å–∏–º auth_data
        try:
            auth_data_dict = json.loads(auth_data_plain)
        except json.JSONDecodeError:
            auth_data_dict = {"cookies": auth_data_plain}
        
        # –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—Å–µ—Ä
        parser = YandexBusinessParser(auth_data_dict)
        account_data = {
            "id": account_id,
            "business_id": business_id,
            "external_id": external_id
        }
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞
        print(f"üîÑ –ü–æ–ª—É—á–∞—é –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ {business_id}...")
        reviews = parser.fetch_reviews(account_data)
        stats = parser.fetch_stats(account_data)
        posts = parser.fetch_posts(account_data)
        org_info = parser.fetch_organization_info(account_data)
        
        # –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ MapParseResults (–µ—Å–ª–∏ –µ—Å—Ç—å)
        cursor.execute("""
            SELECT rating, reviews_count, unanswered_reviews_count, news_count, photos_count
            FROM MapParseResults
            WHERE business_id = ?
            ORDER BY created_at DESC
            LIMIT 1
        """, (business_id,))
        existing_data = cursor.fetchone()
        
        # –í–ê–ñ–ù–û: Fallback –ø–∞—Ä—Å–∏–Ω–≥ –ø–æ–ª—É—á–∞–µ—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ –∑–∞–Ω–æ–≤–æ
        # –≠—Ç–æ –Ω–µ "–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ", –∞ –ø–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞
        # 
        # –ü—Ä–∏—á–∏–Ω—ã:
        # 1. –ö–∞–±–∏–Ω–µ—Ç –¥–∞–µ—Ç –±–æ–ª–µ–µ –ø–æ–ª–Ω—ã–µ –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        # 2. –ü—Ä–æ—â–µ –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É, —á–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å —á—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
        # 3. –î–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–µ (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π API)
        #
        # –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–ø–æ–ª–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É:
        # - –ü—Ä–æ–≤–µ—Ä—è—Ç—å, –∫–∞–∫–∏–µ –ø–æ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –ø—É–±–ª–∏—á–Ω–æ–º –ø–∞—Ä—Å–∏–Ω–≥–µ
        # - –ó–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞
        # –ù–æ —ç—Ç–æ —É—Å–ª–æ–∂–Ω—è–µ—Ç –∫–æ–¥ –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–º
        
        # –ü–æ–ª—É—á–∞–µ–º –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞
        parse_id = str(uuid.uuid4())
        reviews_without_response = sum(1 for r in reviews if not r.response_text) if reviews else 0
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–∞–±–∏–Ω–µ—Ç—É)
        # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤ –∫–∞–±–∏–Ω–µ—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        rating = org_info.get('rating') if org_info and org_info.get('rating') else (existing_data[0] if existing_data and existing_data[0] else None)
        reviews_count = len(reviews) if reviews else (existing_data[1] if existing_data and existing_data[1] else 0)
        news_count = len(posts) if posts else (existing_data[3] if existing_data and existing_data[3] else 0)
        photos_count = org_info.get('photos_count', 0) if org_info else (existing_data[4] if existing_data and existing_data[4] else 0)
        
        cursor.execute("""
            INSERT INTO MapParseResults (
                id, business_id, url, map_type, rating, reviews_count, 
                unanswered_reviews_count, news_count, photos_count, 
                created_at
            )
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
        """, (
            parse_id,
            business_id,
            url or f"https://yandex.ru/sprav/{external_id or 'unknown'}",
            'yandex',
            rating,
            reviews_count,
            reviews_without_response,
            news_count,
            photos_count,
        ))
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–∑—ã–≤—ã –≤ ExternalBusinessReviews
        # (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É –∏–∑ _sync_yandex_business_sync_task)
        
        db.conn.commit()
        db.close()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
        conn = get_db_connection()
        cursor = conn.cursor()
        cursor.execute("""
            UPDATE ParseQueue 
            SET status = 'completed', updated_at = CURRENT_TIMESTAMP
            WHERE id = ?
        """, (queue_dict["id"],))
        conn.commit()
        conn.close()
        
        print(f"‚úÖ Fallback –ø–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ {business_id}")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ fallback –ø–∞—Ä—Å–∏–Ω–≥–∞: {e}")
        import traceback
        traceback.print_exc()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ error
        conn = get_db_connection()
        cursor = conn.cursor()
        cursor.execute("""
            UPDATE ParseQueue 
            SET status = 'error', 
                error_message = ?,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = ?
        """, (str(e), queue_dict["id"]))
        conn.commit()
        conn.close()
```

---

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

1. **–°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
   - `_is_parsing_successful()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
   - `_has_cabinet_account()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–∞–±–∏–Ω–µ—Ç–∞

2. **–ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ parse_card:**
   - –ü–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —É—Å–ø–µ—à–Ω–æ—Å—Ç—å
   - –ï—Å–ª–∏ –Ω–µ—É—Å–ø–µ—à–Ω–æ –∏ –µ—Å—Ç—å –∫–∞–±–∏–Ω–µ—Ç ‚Üí —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–¥–∞—á—É fallback

3. **–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É parse_cabinet_fallback:**
   - –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `_process_cabinet_fallback_task()`
   - –î–æ–±–∞–≤–∏—Ç—å –≤ `process_queue()` –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏

4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:**
   - –ü—É–±–ª–∏—á–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Å –∫–∞–ø—á–µ–π ‚Üí –¥–æ–ª–∂–Ω–∞ —Å–æ–∑–¥–∞—Ç—å—Å—è –∑–∞–¥–∞—á–∞ fallback
   - –ü—É–±–ª–∏—á–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Å –Ω–µ–ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ ‚Üí –¥–æ–ª–∂–Ω–∞ —Å–æ–∑–¥–∞—Ç—å—Å—è –∑–∞–¥–∞—á–∞ fallback
   - Fallback –ø–∞—Ä—Å–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –¥–æ–ø–æ–ª–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ

---

## –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –∫–æ–¥–µ—Ä–∞

- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `_is_parsing_successful()` –≤ `worker.py`
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `_has_cabinet_account()` –≤ `worker.py`
- [ ] –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ `parse_card` –≤ `process_queue()`:
  - –ü–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —É—Å–ø–µ—à–Ω–æ—Å—Ç—å
  - –°–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–¥–∞—á—É fallback –ø—Ä–∏ –Ω–µ—É—Å–ø–µ—Ö–µ
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `_process_cabinet_fallback_task()` –≤ `worker.py`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É `task_type = 'parse_cabinet_fallback'` –≤ `process_queue()`
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:
  - –ü–∞—Ä—Å–∏–Ω–≥ —Å –∫–∞–ø—á–µ–π ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ fallback –∑–∞–¥–∞—á–∏
  - –ü–∞—Ä—Å–∏–Ω–≥ —Å –Ω–µ–ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ fallback –∑–∞–¥–∞—á–∏
  - Fallback –ø–∞—Ä—Å–∏–Ω–≥ ‚Üí –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

---

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:**
   - **Fallback –ø–∞—Ä—Å–∏–Ω–≥ –ø–æ–ª—É—á–∞–µ—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ –∑–∞–Ω–æ–≤–æ** (–Ω–µ —Ç–æ–ª—å–∫–æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ)
   - –ü—Ä–∏—á–∏–Ω—ã:
     - –ö–∞–±–∏–Ω–µ—Ç –¥–∞–µ—Ç –±–æ–ª–µ–µ –ø–æ–ª–Ω—ã–µ –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
     - –ü—Ä–æ—â–µ –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É, —á–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å —á—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
     - –î–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–µ (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π API)
   - **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):** –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É "—É–º–Ω–æ–≥–æ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è":
     - –ü—Ä–æ–≤–µ—Ä—è—Ç—å, –∫–∞–∫–∏–µ –ø–æ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –ø—É–±–ª–∏—á–Ω–æ–º –ø–∞—Ä—Å–∏–Ω–≥–µ
     - –ó–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞
     - –ù–æ —ç—Ç–æ —É—Å–ª–æ–∂–Ω—è–µ—Ç –∫–æ–¥ –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–º

2. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–∞–Ω–Ω—ã—Ö:**
   - –î–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–±–æ–ª–µ–µ –ø–æ–ª–Ω—ã–µ –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ)
   - –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤ –∫–∞–±–∏–Ω–µ—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–∑ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞

3. **–ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã:**
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å, –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ –ª–∏ —É–∂–µ –∑–∞–¥–∞—á–∞ fallback –¥–ª—è —ç—Ç–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞
   - –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `parent_task_id` –¥–ª—è —Å–≤—è–∑–∏ –∑–∞–¥–∞—á

4. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
   - Fallback —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É –±–∏–∑–Ω–µ—Å–∞ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
   - –ù–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ –∫–∞–±–∏–Ω–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã, –ø—É–±–ª–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)

5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
   - Fallback –ø–∞—Ä—Å–∏–Ω–≥ –º–µ–¥–ª–µ–Ω–Ω–µ–µ (HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ API –∫–∞–±–∏–Ω–µ—Ç–∞)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (–Ω–µ—É—Å–ø–µ—à–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥)

---

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
- –ü—É–±–ª–∏—á–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ ‚Üí –µ—Å–ª–∏ –Ω–µ—É—Å–ø–µ—à–µ–Ω ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ fallback
- Fallback –ø–∞—Ä—Å–∏–Ω–≥ –¥–æ–ø–æ–ª–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞
- –ë–æ–ª–µ–µ –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±–∏–∑–Ω–µ—Å–æ–≤ —Å –∫–∞–±–∏–Ω–µ—Ç–æ–º
- –ú–µ–Ω—å—à–µ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑-–∑–∞ –∫–∞–ø—á–∏/–±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

